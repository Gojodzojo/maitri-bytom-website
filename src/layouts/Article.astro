---
import Base from "./Base.astro";
import ImageSlider from "$components/ImageSlider.svelte";
import type { ArticleMarkdown } from "$scripts/types";
import { makeDescription } from "$scripts/makeDescription";
import ZoomableImg from "$components/ZoomableImg.svelte";

interface Props {
  markdown: ArticleMarkdown;
}

const { markdown } = Astro.props;
const { frontmatter, compiledContent } = markdown;
const { title, date, author, image_gallery, tags } = frontmatter;

const splittedContent = compiledContent().split(/(<img.*?>)/g);

function getTagProperties(s: string) {
  const tagPropertyNameRegex = /(?<=\s)(.*?)(?==")/g;
  const tagPropertyValueRegex = /(?<==")(.*?)(?=")/g;

  let tagPropertyName: RegExpExecArray;
  let tagPropertyValue: RegExpExecArray;
  let properties: Record<string, string> = {};
  while (
    (tagPropertyName = tagPropertyNameRegex.exec(s)!) &&
    (tagPropertyValue = tagPropertyValueRegex.exec(s)!)
  ) {
    properties[tagPropertyName[0]] = tagPropertyValue[0];
  }

  return properties;
}
---

<Base title={title} description={makeDescription(compiledContent())}>
  <article>
    <h1>{title}</h1>

    {
      author && date && (
        <h4>
          {author}
          <br />
          {new Date(date).toLocaleDateString("pl")}
        </h4>
      )
    }

    {
      splittedContent.map((s) => {
        if (!s.includes("<img")) return <Fragment set:html={s} />;

        // CustomImg must be wrapped in div because
        // otherwise it is duplicated for some reason
        return (
          <div>
            <ZoomableImg {...getTagProperties(s)} client:load />
          </div>
        );
      })
    }

    {
      image_gallery && image_gallery.length > 0 && (
        <ImageSlider client:load images={image_gallery} />
      )
    }

    {
      tags && tags.length > 0 && (
        <h4 class="tags">
          Tagi:
          {tags.sort().map((tag, index) => (
            <>
              <a href={`/tag/${tag}/1`}>{tag}</a>
              {index !== tags.length - 1 && <span>, </span>}
            </>
          ))}
        </h4>
      )
    }
  </article>
</Base>
<style>
  article {
    padding: var(--vertical-page-margin) var(--horizontal-page-margin);
  }

  h1 {
    margin-bottom: 2em;
  }

  .tags a {
    transition: color 0.2s;
    color: black;
  }

  .tags a:hover {
    color: var(--highlight-color);
  }
</style>
